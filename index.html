<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Overall Cohort Statistics Calculator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 2rem;
            line-height: 1.6;
        }
        h1 {
            margin-bottom: 0.5rem;
        }
        p {
            margin-top: 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 0.5rem;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
        }
        input[type="number"] {
            width: 6rem;
            padding: 0.3rem;
        }
        .btn {
            margin-top: 1rem;
            padding: 0.6rem 1.2rem;
            font-size: 1rem;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 4px;
        }
        .btn:hover {
            background-color: #45a049;
        }
        .result {
            margin-top: 1.5rem;
            font-weight: bold;
            font-size: 1.1rem;
        }
        label {
            display: block;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <h1>Overall Cohort Statistics Calculator</h1>
    <p>
        Use this tool to combine the sample size (<em>n</em>), mean and standard deviation (SD) of up to 10 subgroups and obtain the overall mean, standard deviation and total sample size. All inputs are required for each subgroup. The calculations use the pooled sample variance formula.
    </p>
    <label for="numGroups"><strong>Number of studies (2–10):</strong></label>
<input id="numGroups"
       type="number"
       min="2"
       max="10"
       step="1"
       value="2"
       inputmode="numeric"
       pattern="[0-9]*"
       style="width: 80px; margin-left: 6px;" />
    <table id="inputTable">
        <thead>
            <tr>
                <th>Group</th>
                <th>Sample Size (n)</th>
                <th>Mean</th>
                <th>Standard Deviation (SD)</th>
            </tr>
        </thead>
        <tbody>
            <!-- Rows will be inserted here by JavaScript -->
        </tbody>
    </table>
    <button id="calculateBtn" class="btn">Calculate</button>
    <div id="results" class="result"></div>
    <script>
    <script>
(function() {
  const MIN_GROUPS = 2;
  const MAX_GROUPS = 10;

  const numGroupsInput = document.getElementById('numGroups');
  const inputTableBody = document.getElementById('inputTable').querySelector('tbody');

  function clamp(v) {
    const n = parseInt(v, 10);
    if (Number.isNaN(n)) return MIN_GROUPS;
    return Math.max(MIN_GROUPS, Math.min(MAX_GROUPS, n));
  }

  function createRows() {
    const boundedNum = clamp(numGroupsInput.value);
    numGroupsInput.value = boundedNum;               // keep the UI in sync
    inputTableBody.innerHTML = '';
    for (let i = 1; i <= boundedNum; i++) {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${i}</td>
        <td><input type="number" min="2" step="1" id="n_${i}" required></td>
        <td><input type="number" step="any" id="mean_${i}" required></td>
        <td><input type="number" step="any" id="sd_${i}" required></td>
      `;
      inputTableBody.appendChild(row);
    }
  }

  // Initial render
  numGroupsInput.value = clamp(numGroupsInput.value || MIN_GROUPS);
  createRows();

  // REACTIVE as-you-type update (this is the “typing reactive”)
  numGroupsInput.addEventListener('input', createRows);

  // Final clamp if the user leaves an out-of-range value
  numGroupsInput.addEventListener('blur', () => {
    numGroupsInput.value = clamp(numGroupsInput.value);
    createRows();
  });

  // Perform calculations
  document.getElementById('calculateBtn').addEventListener('click', function() {
    const num = clamp(numGroupsInput.value);
    if (num < MIN_GROUPS || num > MAX_GROUPS) {
      alert(`Please specify a number of subgroups between ${MIN_GROUPS} and ${MAX_GROUPS}.`);
      return;
    }

    let totalN = 0;
    let weightedMeanNumerator = 0;
    const ns = [];
    const means = [];
    const sds = [];

    for (let i = 1; i <= num; i++) {
      const nVal = document.getElementById(`n_${i}`).value;
      const meanVal = document.getElementById(`mean_${i}`).value;
      const sdVal = document.getElementById(`sd_${i}`).value;

      const n = parseFloat(nVal);
      const m = parseFloat(meanVal);
      const sd = parseFloat(sdVal);

      if (isNaN(n) || isNaN(m) || isNaN(sd)) {
        alert('Please fill in all fields for subgroup ' + i + '.');
        return;
      }
      if (n < 2) {
        alert('Sample size must be at least 2 for subgroup ' + i + ' (SD is undefined for n < 2).');
        return;
      }

      ns.push(n); means.push(m); sds.push(sd);
      totalN += n;
      weightedMeanNumerator += n * m;
    }

    if (totalN <= 0) {
      alert('Total sample size must be greater than 0.');
      return;
    }

    const overallMean = weightedMeanNumerator / totalN;

    let sumTerms = 0;
    for (let i = 0; i < num; i++) {
      const ni = ns[i], sd_i = sds[i], mean_i = means[i];
      sumTerms += (ni - 1) * Math.pow(sd_i, 2) + ni * Math.pow(mean_i - overallMean, 2);
    }
    const overallVariance = sumTerms / (totalN - 1);
    const overallSD = Math.sqrt(overallVariance);

    const resultsDiv = document.getElementById('results');
    resultsDiv.innerHTML = [
      `<p>Total sample size (N): ${totalN.toFixed(0)}</p>`,
      `<p>Overall mean: ${overallMean.toFixed(4)}</p>`,
      `<p>Overall standard deviation: ${overallSD.toFixed(4)}</p>`
    ].join('');
  });
})();
</script>
</body>
</html>
